<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.thymeleaf.org/schema/layout" layout:decorate="~{default}">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<!--  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/agate.min.css">-->
<!--  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<div layout:fragment="content" id="layoutSidenav_content">
  <main>
    <div class="container-fluid px-4">
      <form id="form" th:action="@{/request}" method="post">
        <div class="row">
          <div class="col-4">
            <h6 class="my-3 border-bottom pb-2">URL</h6>
          </div>
          <div class="col-4">
            <h6 class="my-3 border-bottom pb-2">Response</h6>
          </div>
        </div>

        <div class="row">
          <div class="col-4">
            <div class="input-group mb-3">
              <input type="text" name="url" id="url" class="form-control" placeholder="Enter URL" aria-describedby="btnGroupAddon" required>
              <button class="btn btn-outline-secondary" type="submit" id="button-addon2">Enter</button>
            </div>

            <div class="mb-3">
              <label for="headers" class="form-label">Headers</label>
              <div id="header-container">
                <div class="input-group mb-2">
                  <input type="text" class="form-control" name="headersKey" placeholder="Header Key">
                  <input type="text" class="form-control" name="headersValue" placeholder="Header Value">
                  <button class="btn btn-danger" type="button" onclick="removeHeader(this)">삭제</button>
                </div>
              </div>
              <button class="btn btn-primary" type="button" onclick="addHeader()">추가</button>
            </div>

            <div class="mb-3">
              <label for="body" class="form-label">Body</label>
              <textarea id="body" name="body" style="display:none;"></textarea>
              <div id="editor"></div>
            </div>
          </div>

          <div class="col-4">
            <div id="responseContainer" class="border p-2" style="height: 200px; overflow-y: auto;">
              <div id="responseEditor">
                <textarea id="responseTextarea" style="display:none;" th:text="${result}"></textarea>
              </div> <!-- 응답을 표시할 CodeMirror 에디터 -->
            </div>
          </div>
        </div>
      </form>
    </div>

    <script>
      // CodeMirror 인스턴스 생성
      const editor = CodeMirror(document.getElementById("editor"), {
          mode: "application/json",
          lineNumbers: true,
          lineWrapping: true,
          theme: "default",
          value: '' // 기본값을 빈 문자열로 설정
      });

      // Response를 위한 CodeMirror 인스턴스 생성
      const responseEditor = CodeMirror(document.getElementById("responseEditor"), {
          mode: "application/json",
          lineNumbers: true,
          lineWrapping: true,
          theme: "default",
          readOnly: true, // 읽기 전용으로 설정
          value: '' // 기본값을 빈 문자열로 설정
      });

      // 페이지 로드 시 저장된 값 복원
      window.onload = function() {
          const savedUrl = localStorage.getItem('url');
          const savedBody = localStorage.getItem('body');
          const savedHeaders = JSON.parse(localStorage.getItem('headers')) || [];

          if (savedUrl) {
              document.getElementById('url').value = savedUrl;
          }
          if (savedBody) {
              editor.setValue(savedBody);
          }
          savedHeaders.forEach(header => {
              addHeader(header.key, header.value);
          });

          // 서버에서 전달받은 결과를 CodeMirror에 설정
          const responseText = document.getElementById("responseTextarea").value;
          responseEditor.setValue(responseText || "No result found in response.");
      };

      // 폼 전송 시 JSON 데이터를 body에 설정
      document.getElementById('form').onsubmit = function() {
          const jsonValue = editor.getValue();
          document.getElementById('body').value = jsonValue; // CodeMirror에서 가져온 값을 textarea에 설정

          // 로컬 스토리지에 값 저장
          localStorage.setItem('url', document.getElementById('url').value);
          localStorage.setItem('body', jsonValue);

          // 헤더 값 저장
          const headers = [];
          const headerInputs = document.querySelectorAll('#header-container .input-group');
          headerInputs.forEach(inputGroup => {
              const key = inputGroup.querySelector('input[name="headersKey"]').value;
              const value = inputGroup.querySelector('input[name="headersValue"]').value;
              if (key && value) {
                  headers.push({ key, value });
              }
          });
          localStorage.setItem('headers', JSON.stringify(headers));
      };

      // 헤더 추가 함수
      function addHeader(key = '', value = '') {
          const headerContainer = document.getElementById("header-container");
          const inputGroup = document.createElement("div");
          inputGroup.className = "input-group mb-2";
          inputGroup.innerHTML = `
              <input type="text" class="form-control" name="headersKey" placeholder="Header Key" value="${key}">
              <input type="text" class="form-control" name="headersValue" placeholder="Header Value" value="${value}">
              <button class="btn btn-danger" type="button" onclick="removeHeader(this)">삭제</button>
          `;
          headerContainer.appendChild(inputGroup);
      }

      // 헤더 삭제 함수
      function removeHeader(button) {
          const inputGroup = button.parentElement;
          inputGroup.remove();
      }
    </script>
  </main>
</div>
</html>